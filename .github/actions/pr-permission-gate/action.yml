name: PR Permission Gate
description: Fails the workflow if the PR sender lacks write access to the repository
runs:
  using: "composite"
  steps:
    - name: Check PR sender permission
      uses: actions/github-script@v7
      with:
        script: |
          const username = context.payload.sender.login;
          const owner = context.repo.owner;
          const repo = context.repo.repo;

          try {
            const { data } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner,
              repo,
              username
            });

            const perm = data.permission;
            core.info(`${username} has ${perm} permission`);

            const levels = ['none', 'read', 'triage', 'write', 'maintain', 'admin'];
            const required = 'write';

            if (levels.indexOf(perm) < levels.indexOf(required)) {
              core.setFailed(`❌ User ${username} has ${perm}, but ${required} permission is required.`);
            } else {
              core.info(`✅ User ${username} passes permission check (${perm} >= ${required})`);
            }
          } catch (error) {
            // Handle case where user isn't a collaborator at all
            if (error.status === 404) {
              core.setFailed(`❌ User ${username} is not a collaborator on ${owner}/${repo}.`);
            } else {
              core.setFailed(`Unexpected error while checking permission: ${error.message}`);
            }
          }
