name: Reusable Release Image Workflow

permissions:
  contents: read

on:
  workflow_call:
    inputs:
      source-image-uri:
        description: 'Source image URI to release'
        required: true
        type: string
      release-spec:
        description: 'Release specification YAML content'
        required: true
        type: string
      environment:
        description: 'Deployment environment (gamma or production)'
        required: true
        type: string
      aws-region:
        description: 'AWS region'
        required: false
        type: string
        default: 'us-west-2'
      runner-fleet:
        description: 'CodeBuild runner fleet'
        required: false
        type: string
        default: 'default-runner'
    outputs:
      run-identifier:
        description: 'Unique identifier for this release run'
        value: ${{ jobs.step1-publish-images.outputs.run-identifier }}

jobs:
  validate-release:
    runs-on: ubuntu-latest
    steps:
      - name: Validate release context
        run: |
          ENVIRONMENT="${{ inputs.environment }}"
          EVENT_NAME="${{ github.event_name }}"

          # Validate environment input
          if [[ "${ENVIRONMENT}" != "gamma" && "${ENVIRONMENT}" != "production" ]]; then
            echo "âŒ ERROR: Invalid environment '${ENVIRONMENT}'"
            echo "Valid environments: gamma, production"
            exit 1
          fi

          # # Block production releases from PRs
          # if [ "${EVENT_NAME}" == "pull_request" ] && [ "${ENVIRONMENT}" == "production" ]; then
          #   echo "âŒ ERROR: Production releases cannot be triggered from pull requests"
          #   echo "Production releases can only be triggered from main branch or scheduled runs"
          #   echo ""
          #   echo "Current context:"
          #   echo "  Event: ${EVENT_NAME}"
          #   echo "  Environment: ${ENVIRONMENT}"
          #   echo ""
          #   echo "To release to production, merge to main branch first."
          #   exit 1
          # fi

          # # Allow gamma releases from PRs (for testing)
          # if [ "${EVENT_NAME}" == "pull_request" ] && [ "${ENVIRONMENT}" == "gamma" ]; then
          #   echo "âœ… Gamma release from PR allowed (testing)"
          # fi

          echo "âœ… Release context validation passed"
          echo "Event: ${EVENT_NAME}"
          echo "Ref: ${{ github.ref }}"
          echo "Environment: ${ENVIRONMENT}"

  step1-publish-images:
    needs: [validate-release]
    environment: ${{ inputs.environment }}
    runs-on:
      - codebuild-runner-${{ github.run_id }}-${{ github.run_attempt }}
        fleet:${{ inputs.runner-fleet }}
        buildspec-override:true
    outputs:
      run-identifier: ${{ steps.setup.outputs.run-identifier }}
      metadata-file-name: ${{ steps.setup.outputs.metadata-file-name }}
      images-published: ${{ steps.publish.outputs.images-published }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup release package
        uses: ./.github/actions/setup-release-package
        with:
          aws-region: ${{ inputs.aws-region }}

      - name: Install SOCI and nerdctl
        run: |
          echo "Installing SOCI and nerdctl..."
          ARCH_SUFFIX="amd64"

          # SOCI SNAPSHOTTER
          if command -v soci &> /dev/null; then
            echo "SOCI already installed:"
            soci --version
          else
            echo "Installing SOCI for ${ARCH_SUFFIX}..."
            SOCI_VERSION="0.11.1"
            wget https://github.com/awslabs/soci-snapshotter/releases/download/v${SOCI_VERSION}/soci-snapshotter-${SOCI_VERSION}-linux-${ARCH_SUFFIX}.tar.gz
            sudo tar -C /usr/local/bin -xvf soci-snapshotter-${SOCI_VERSION}-linux-${ARCH_SUFFIX}.tar.gz soci soci-snapshotter-grpc
            rm soci-snapshotter-${SOCI_VERSION}-linux-${ARCH_SUFFIX}.tar.gz
            soci --version
          fi

          # NERDCTL
          if command -v nerdctl &> /dev/null; then
            echo "nerdctl already installed:"
            nerdctl --version
          else
            echo "Installing nerdctl for ${ARCH_SUFFIX}..."
            export CONTAINERD_ADDRESS=/var/run/docker/containerd/containerd.sock
            NERDCTL_VERSION="2.1.5"
            wget https://github.com/containerd/nerdctl/releases/download/v${NERDCTL_VERSION}/nerdctl-${NERDCTL_VERSION}-linux-${ARCH_SUFFIX}.tar.gz
            sudo tar -C /usr/local/bin -xzf nerdctl-${NERDCTL_VERSION}-linux-${ARCH_SUFFIX}.tar.gz
            sudo chmod +x /usr/local/bin/nerdctl
            rm nerdctl-${NERDCTL_VERSION}-linux-${ARCH_SUFFIX}.tar.gz
            nerdctl --version
          fi

          echo "CONTAINERD_ADDRESS=/var/run/docker/containerd/containerd.sock" >> ${GITHUB_ENV}

      - name: Setup release environment
        id: setup
        run: |
          # Extract a unique identifier from the source image URI
          # Example: 123456789.dkr.ecr.us-west-2.amazonaws.com/vllm:0.14.0-gpu-py3.11-cu12.4-ubuntu22.04-ec2-pr-123
          # Extract the tag portion after the last colon
          IMAGE_TAG=$(echo "${{ inputs.source-image-uri }}" | rev | cut -d':' -f1 | rev)
          # Sanitize the tag to be filesystem-safe (replace special chars with dashes)
          SANITIZED_TAG=$(echo "${IMAGE_TAG}" | tr '/:.' '-')

          RUN_IDENTIFIER="${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}-${SANITIZED_TAG}"
          METADATA_FILE="/tmp/release_metadata_${RUN_IDENTIFIER}.dict"

          echo "RUN_IDENTIFIER=${RUN_IDENTIFIER}" >> ${GITHUB_ENV}
          echo "METADATA_FILE=${METADATA_FILE}" >> ${GITHUB_ENV}
          echo "REGION=${{ inputs.aws-region }}" >> ${GITHUB_ENV}
          echo "SOURCE_STAGE=${{ vars.SOURCE_STAGE }}" >> ${GITHUB_ENV}
          echo "TARGET_STAGE=${{ vars.TARGET_STAGE }}" >> ${GITHUB_ENV}

          echo "run-identifier=${RUN_IDENTIFIER}" >> ${GITHUB_OUTPUT}
          echo "metadata-file-name=release_metadata_${RUN_IDENTIFIER}.dict" >> ${GITHUB_OUTPUT}

          echo "Generated run identifier: ${RUN_IDENTIFIER}"
          echo "Environment: ${{ inputs.environment }}"
          echo "Source stage: ${{ vars.SOURCE_STAGE }}"
          echo "Target stage: ${{ vars.TARGET_STAGE }}"

      - name: Publish DLC Images
        id: publish
        run: |
          echo "=========================================="
          echo "Step 1: Publishing DLC Images"
          echo "=========================================="

          cat > release_spec.yml <<'EOF'
          ${{ inputs.release-spec }}
          EOF

          echo "Release specification:"
          cat release_spec.yml

          publish_dlc_images \
            --release-spec release_spec.yml \
            --source-image-uri "${{ inputs.source-image-uri }}" \
            --metadata-file "${METADATA_FILE}"

          # Read IMAGES_PUBLISHED from the metadata file
          # The Python script sets this in the metadata, but env vars don't propagate from subprocess
          if [ -f "${METADATA_FILE}" ]; then
            IMAGES_PUBLISHED=$(python3 -c "import json; print(json.load(open('${METADATA_FILE}'))['release_successful'])")
            echo "images-published=${IMAGES_PUBLISHED}" >> ${GITHUB_OUTPUT}

            if [ "${IMAGES_PUBLISHED}" == "1" ]; then
              echo "âœ… Step 1 completed: Images published successfully"
            else
              echo "âš ï¸ Step 1 completed but release was skipped (no images published)"
            fi
            echo "Release metadata:"
            cat ${METADATA_FILE}
          else
            echo "âŒ Error: Metadata file not found"
            exit 1
          fi

      - name: Upload metadata artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-metadata-${{ steps.setup.outputs.run-identifier }}
          path: ${{ env.METADATA_FILE }}
          retention-days: 7

  step2-generate-info:
    needs: [step1-publish-images]
    environment: ${{ inputs.environment }}
    if: needs.step1-publish-images.outputs.images-published == '1'
    runs-on:
      - codebuild-runner-${{ github.run_id }}-${{ github.run_attempt }}
        fleet:${{ inputs.runner-fleet }}
        buildspec-override:true
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup release package
        uses: ./.github/actions/setup-release-package
        with:
          aws-region: ${{ inputs.aws-region }}

      - name: Download metadata artifact
        uses: actions/download-artifact@v4
        with:
          name: release-metadata-${{ needs.step1-publish-images.outputs.run-identifier }}
          path: /tmp/

      - name: Setup environment
        run: |
          RUN_IDENTIFIER="${{ needs.step1-publish-images.outputs.run-identifier }}"
          METADATA_FILE="/tmp/${{ needs.step1-publish-images.outputs.metadata-file-name }}"

          echo "RUN_IDENTIFIER=${RUN_IDENTIFIER}" >> ${GITHUB_ENV}
          echo "METADATA_FILE=${METADATA_FILE}" >> ${GITHUB_ENV}
          echo "REGION=${{ inputs.aws-region }}" >> ${GITHUB_ENV}
          echo "SOURCE_STAGE=${{ vars.SOURCE_STAGE }}" >> ${GITHUB_ENV}
          echo "TARGET_STAGE=${{ vars.TARGET_STAGE }}" >> ${GITHUB_ENV}

      - name: Generate Release Information
        run: |
          echo "=========================================="
          echo "Step 2: Generating Release Information"
          echo "=========================================="

          if [ ! -f "${METADATA_FILE}" ]; then
            echo "âŒ Error: Metadata file not found at ${METADATA_FILE}"
            exit 1
          fi

          echo "Release metadata from Step 1:"
          cat ${METADATA_FILE}

          generate_dlc_image_release_information \
            --metadata-file "${METADATA_FILE}" \
            --run-id "${RUN_IDENTIFIER}"

          echo "âœ… Step 2 completed: Release information generated and uploaded to S3"

  step3-publish-notifications:
    needs: [step1-publish-images, step2-generate-info]
    environment: ${{ inputs.environment }}
    if: needs.step1-publish-images.outputs.images-published == '1'
    runs-on:
      - codebuild-runner-${{ github.run_id }}-${{ github.run_attempt }}
        fleet:${{ inputs.runner-fleet }}
        buildspec-override:true
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup release package
        uses: ./.github/actions/setup-release-package
        with:
          aws-region: ${{ inputs.aws-region }}

      - name: Setup environment
        run: |
          RUN_IDENTIFIER="${{ needs.step1-publish-images.outputs.run-identifier }}"
          echo "RUN_IDENTIFIER=${RUN_IDENTIFIER}" >> ${GITHUB_ENV}
          echo "REGION=${{ inputs.aws-region }}" >> ${GITHUB_ENV}
          echo "SOURCE_STAGE=${{ vars.SOURCE_STAGE }}" >> ${GITHUB_ENV}
          echo "TARGET_STAGE=${{ vars.TARGET_STAGE }}" >> ${GITHUB_ENV}

      - name: Publish Release Information
        run: |
          echo "=========================================="
          echo "Step 3: Publishing Release Information"
          echo "=========================================="

          publish_release_information --run-id "${RUN_IDENTIFIER}"

          echo "âœ… Step 3 completed: Release information published successfully"
          echo ""
          echo "=========================================="
          echo "ðŸŽ‰ All release steps completed successfully!"
          echo "=========================================="