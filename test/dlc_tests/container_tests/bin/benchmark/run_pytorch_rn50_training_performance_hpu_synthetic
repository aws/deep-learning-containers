#!/bin/bash

PT_VERSION=$(python -c 'import torch; print(torch.__version__)')

HOME_DIR=/test
BIN_DIR=${HOME_DIR}/bin
LOG_DIR=`dirname $LOG_FILE`
DATA_DIR=${HOME_DIR}/artifacts/syntheticData
DATA_GENERATOR=${BIN_DIR}/habana_tests/pytorch/benchmark/pt_resnet_synthetic_data_gen.sh
GENERATE_SYNTHETIC_DATA="true"

mkdir -p ${HOME_DIR}/artifacts
mkdir -p ${BIN_DIR}
mkdir -p ${LOG_DIR}

LINUX_DIST_NAME=`cat /etc/*-release | grep "^NAME=" | sed 's#^.*=##' | tr -d '"'`
if [ -z "$LINUX_DIST_NAME" ]; then
    echo Unable to identify Linux distribution
    exit 1
elif [ "$LINUX_DIST_NAME" == "Ubuntu" ]; then
    apt-get update
    apt-get install -y imagemagick
elif [ "$LINUX_DIST_NAME" == "Amazon Linux" ]; then
    yum update -y
    yum install -y ImageMagick
else
    echo Unknown Linux distribution: $LINUX_DIST_NAME
    exit 1
fi

echo "Generate synthetic data"
if [ ! -d ${DATA_DIR} ]; then
    chmod +x ${DATA_GENERATOR}
    ${DATA_GENERATOR} -n 10 -d ${DATA_DIR}
    if [ $? -ne 0 ]; then
        exit 1
    fi
fi

git clone https://github.com/HabanaAI/Model-References.git ${HOME_DIR}/artifacts/Model-References
cd ${HOME_DIR}/artifacts/Model-References
git checkout ${GIT_BRANCH}

RESNET_DIR="${HOME_DIR}/artifacts/Model-References/PyTorch/computer_vision/ImageClassification/ResNet"
export PYTHONPATH=${HOME_DIR}/artifacts/Model-References:$PYTHONPATH

set -e

START=$(date +%s)
TRAINING_TIME="100m"
if [ "$PR_CONTEXT" == "1" ]
then
  TRAINING_TIME="100m"
  echo Running under PR context >&2
fi
if [ "$CARDS_NUM" == "1" ]; then
  WORLD_SIZE=1
  PRINT_FREQZ=20
  NUM_WORKER=12
  DL_WORKER_TYPE_STR="--dl-worker-type MP"
  CUSTOM_LR_VALUES="0.005,0.0005,0.00005"
  CUSTOM_LR_MILESTONES="30,60,80"
else
  WORLD_SIZE=8
  PRINT_FREQZ=1
  NUM_WORKER=8
  DL_WORKER_TYPE_STR=""
  CUSTOM_LR_VALUES="0.275,0.45,0.625,0.8,0.08,0.008,0.0008"
  CUSTOM_LR_MILESTONES="1,2,3,4,30,60,80"
fi

timeout "${TRAINING_TIME}" python -u \
  ${RESNET_DIR}/demo_resnet.py \
  --world-size ${WORLD_SIZE} ${DL_WORKER_TYPE_STR} --batch-size 256 --model resnet50 --device hpu \
  --workers ${NUM_WORKER} --print-freq ${PRINT_FREQZ} --channels-last True --deterministic --dl-time-exclude=False \
  --data-path ${DATA_DIR} --mode lazy --epochs 90 --data-type bf16 \
  --custom-lr-values ${CUSTOM_LR_VALUES} --custom-lr-milestones ${CUSTOM_LR_MILESTONES} 2>&1 | tee ${LOG_FILE}

END=$(date +%s)
DIFF=$(( END - START ))
echo Script took $(( DIFF/60 )) mins to finish >> "${LOG_FILE}"
set +e

rm -rf ${HOME_DIR}/artifacts/Model-References

exit 0
