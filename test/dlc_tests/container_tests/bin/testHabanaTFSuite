#!/bin/bash

HOME_DIR=/test
TEST_DIR=${HOME_DIR}/bin/habana_tests/tensorflow
TF_VERSION=v2.5.0
RETURNVAL=0

cd ${TEST_DIR}/google_tf_tests

pip install portpicker==1.3.1
pip install pytest==3.10.0
pip install pytest_logger==0.5.1
pip install pytest-forked==1.3.0
pip install pytest-xdist==1.22.2
pip install pytest-timeout==1.4.2
pip install junitparser==2.1.1

## Clone open source TensorFlow
git clone https://github.com/tensorflow/tensorflow.git
cd tensorflow
git checkout $TF_VERSION
cd ..


## Copy files from open source to TF version test directory
./copy_test_from_tf.py -sp $PWD/tensorflow -dp $PWD/$TF_VERSION

./run_tests.sh $TF_VERSION/tensorflow/python/ops
RETURNVAL+=$?
./run_tests.sh $TF_VERSION/tensorflow/python/keras
RETURNVAL+=$?
./run_tests.sh $TF_VERSION/tensorflow/python/kernel_tests
RETURNVAL+=$?

if [ $RETURNVAL -eq 0 ];
then
    echo "TensorFlow test suite executed successfully"
    exit 0
else
    echo "TensorFlow test suite terminated unsuccessfully"
    exit $RETURNVAL
fi
