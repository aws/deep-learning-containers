#!/bin/bash

HOME_DIR=/test
BIN_DIR=${HOME_DIR}/bin
LOG_DIR=${HOME_DIR}/logs

TORCHDATA_BRANCH_DEFAULT="main"
TORCHDATA_REPO="https://github.com/pytorch/data.git"
TORCHDATA_TEST_SCRIPT="data/test/test_remote_io.py"

echo "Fetch Torchdata S3 IO test script."
TORCHDATA_RELEASE_TAG=$(python -c "import torchdata as td; print(td.__version__.split('+')[0])")
# checkout latest commit on main branch as of 10/12/23, as it has been tested to work on PT 2.0.1 and PT 2.1.0. 
# torchdata is no longer being maintained, so the test script most likely will not be updated after this.
git clone $TORCHDATA_REPO \
    && pushd data \
    && git checkout ce075397428c90be312f87b60d4701b2e3ff3700 \
    && popd

# removing awscli requirement as it should already be installed, and is causing dependency issues
sed -i "s/awscli.*//g" data/test/requirements.txt
# removing adlfs requirement as it is a library for Azure, and is causing dependency issues
sed -i "s/adlfs.*//g" data/test/requirements.txt

echo "Installing pre-requisites."
pip install -r data/test/requirements.txt

echo "Running Torchdata S3 IO datapipe tests."
pytest data/test/test_remote_io.py

if [ "$?" -eq "0" ]
then
    echo "Torchdata S3 IO tests succeeded."
else
    echo "Torchdata S3 IO tests failed at ${TORCHDATA_REPO} ${TORCHDATA_BRANCH} ${TORCHDATA_TEST_SCRIPT}"
    exit 1
fi

exit 0
