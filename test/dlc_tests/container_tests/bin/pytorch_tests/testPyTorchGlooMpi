#!/bin/bash

set -e

# check GPU status
if nvidia-smi &> /dev/null; then
   DEVICE="cuda"
   NUM_GPUS=$(nvidia-smi -L | wc -l)
else
   DEVICE="cpu"
   NUM_GPUS=0
fi

git config --global user.email "you@example.com"
git config --global user.name "Your Name"

if which conda >/dev/null 2>&1; then
    conda init
    source ~/.bashrc
fi

source /test/bin/pytorch_tests/installPyTorchBenchmarkRepository

export PT_BACKEND=$1
export USE_INDUCTOR=$2
# assign the lower of 2 and gpu #, or 2 when no gpu
export WORLD_SIZE=$(($NUM_GPUS == 0 ? 2 : ($NUM_GPUS < 2 ? $NUM_GPUS : 2)))

OUT_PATH=$AWS_LOG_DIR/aws_res.csv timeout 360 python run.py BERT_pytorch -d $DEVICE -t train

exit 0
