#!/bin/bash

set -e

source /test/bin/pytorch_tests/setupPyTorchBackendTest

export WORLD_SIZE=2
USE_INDUCTOR=1 PT_BACKEND=gloo OUT_PATH=$AWS_LOG_DIR/aws_gloo_res.csv timeout 360 python run.py BERT_pytorch -m eager -d $DEVICE -t train

# get OSS perf data
bash ${BIN_DIR}/pytorch_tests/installOSSPyTorch
# re-install requirements as some might be gone with pytorch
pip install -r requirements.txt 

USE_INDUCTOR=1 PT_BACKEND=gloo OUT_PATH=$OSS_LOG_DIR/oss_gloo_res.csv timeout 360 python run.py BERT_pytorch -m eager -d $DEVICE -t train

# compare aws and oss results process by process
for ((i=0; i<$WORLD_SIZE; i++))
do
  bash ${BIN_DIR}/pytorch_tests/evaluateResults "$AWS_LOG_DIR/aws_gloo_res.csv_$i" "$OSS_LOG_DIR/oss_gloo_res.csv_$i"
done

exit 0