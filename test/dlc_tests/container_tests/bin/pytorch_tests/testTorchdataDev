#!/bin/bash

HOME_DIR=/test
BIN_DIR=${HOME_DIR}/bin
LOG_DIR=${HOME_DIR}/logs

TORCHDATA_REPO="https://github.com/pytorch/data.git"
TORCHDATA_TEST_SCRIPT="test/test_remote_io.py"
TORCHDATA_RELEASE_TAG=$(python -c "import torchdata; torchdata_versions = torchdata.__version__.split('.'); print(f'release/{torchdata_versions[0]}.{torchdata_versions[1]}')")

echo adding temp git config user email and name
git config --global user.email "you@example.com"
git config --global user.name "Your Name"

echo cloning torchdata repo
git clone ${TORCHDATA_REPO}
cd data

echo Patching test_remote_io for E3 bucket issue
git checkout ${TORCHDATA_RELEASE_TAG}
git cherry-pick 2a58c306f11225264a2f432f3d483fca61e9576d --strategy-option theirs
git commit -a
git cherry-pick c109c3a107a434db1904cd3ed0e9acab585508cc --strategy-option theirs

echo "Installing pre-requisites."
pip install expecttest

echo "Running Torchdata S3 IO datapipe tests."
python ${TORCHDATA_TEST_SCRIPT}

if [ "$?" -eq "0" ]
then
    echo "Torchdata S3 IO tests succeeded."
    exit 0
else
    echo "Torchdata S3 IO tests failed at ${TORCHDATA_DEV_REPO} ${TORCHDATA_DEV_BRANCH} ${TORCHDATA_TEST_SCRIPT}"
    exit 1
fi
