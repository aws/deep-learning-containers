import os
import json

import pytest

from test.test_utils import (
    LOGGER,
)
# Required to prevent circular dependency while importing
from test.test_utils import ecr as ecr_utils
from test.test_utils.security import (
    CVESeverity,
    ECREnhancedScanVulnerabilityList,
)

@pytest.mark.usefixtures("sagemaker")
@pytest.mark.model("N/A")
@pytest.mark.integration("Check if ECR Scan data is read properly")
def test_read_from_ecr_scan():
    with open('./sanity/resources/ecr_scan_result1.json', 'r') as f:
        scan_results = json.load(f)
    minimum_sev_threshold="HIGH"
    ecr_image_vulnerability_list = ECREnhancedScanVulnerabilityList(minimum_severity=CVESeverity[minimum_sev_threshold])
    ecr_image_vulnerability_list.construct_allowlist_from_ecr_scan_result(scan_results)
    with open(f'./sanity/resources/allowlist1.json', 'r') as f:
        expected_result = json.load(f)
    assert expected_result == ecr_image_vulnerability_list.vulnerability_list
    assert expected_result == ecr_image_vulnerability_list.get_sorted_vulnerability_list()